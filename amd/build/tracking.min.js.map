{"version":3,"file":"tracking.min.js","sources":["../src/tracking.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This plugin provides access to Moodle data in form of analytics and reports in real time.\n *\n * @copyright  2020 IntelliBoard, Inc\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @see    https://intelliboard.net/\n */\ndefine([\n        'jquery',\n        'core/log',\n        'local_intellidata/tracking_repository',\n        'local_intellidata/cookies_helper'\n    ],\n    function(\n        $,\n        log,\n        TrackingRepository,\n        CookiesHelper\n    ) {\n\n        var PARAMS = {\n            AJAXFREQUENCY: 30,\n            INACTIVITY: 60,\n            PERIOD: 1000,\n            INTERVAL: null,\n            PAGE: '',\n            PARAM: '',\n            MEDIATRACK: 0,\n        };\n\n        var TRACKING = {\n            COUNTER: 0,\n            AJAXCOUNTER: 0,\n            WARNINGTIME: 0,\n            LOGOUTTIME: 0\n        };\n\n        var registerParams = function(params) {\n            PARAMS.INACTIVITY = params.inactivity || PARAMS.INACTIVITY;\n            PARAMS.AJAXFREQUENCY = params.ajaxfrequency || PARAMS.AJAXFREQUENCY;\n            PARAMS.PERIOD = params.period || PARAMS.PERIOD;\n            PARAMS.PAGE = params.page || PARAMS.PAGE;\n            PARAMS.PARAM = params.param || PARAMS.PARAM;\n            PARAMS.MEDIATRACK = params.mediatrack || PARAMS.MEDIATRACK;\n            log.debug('IntelliData: Set Params', [PARAMS, TRACKING]);\n        };\n\n        var registerEventListeners = function() {\n            $(document).on(\"mousemove\", clearCounter);\n            $(document).on(\"keypress\", clearCounter);\n            $(document).on(\"scroll\", clearCounter);\n            $(window).on(\"unload\", resetParams);\n        };\n\n        var clearCounter = function() {\n            TRACKING.COUNTER = 0;\n            TRACKING.WARNINGTIME = 0;\n            TRACKING.LOGOUTTIME = 0;\n        };\n\n        var resetParams = function() {\n            CookiesHelper.setCookie('intellidatapage', PARAMS.PAGE);\n            CookiesHelper.setCookie('intellidataparam', PARAMS.PARAM);\n            CookiesHelper.setCookie('intellidatatime', PARAMS.AJAXFREQUENCY);\n        };\n\n        var initTracking = function() {\n            setInterval(track, PARAMS.PERIOD);\n            log.debug('IntelliData: Start Tracking', [PARAMS, TRACKING]);\n        };\n\n        var track = function() {\n            if (PARAMS.MEDIATRACK) {\n                var status = mediaTracking();\n                if (status && !document.hidden) {\n                    clearCounter();\n                }\n            }\n            if (TRACKING.COUNTER <= PARAMS.INACTIVITY) {\n                TRACKING.COUNTER++;\n                TRACKING.AJAXCOUNTER++;\n\n                if (TRACKING.AJAXCOUNTER == PARAMS.AJAXFREQUENCY && PARAMS.AJAXFREQUENCY) {\n                    TrackingRepository.sendRequest(PARAMS.PAGE, PARAMS.PARAM);\n                    TRACKING.AJAXCOUNTER = 0;\n                }\n            }\n        };\n\n        var mediaTracking = function(){\n            var media = [];\n            var status = false;\n\n            // Track Video.js players by checking for vjs-playing class\n            var videoJsPlayers = document.querySelectorAll('.video-js');\n            if (videoJsPlayers.length) {\n                videoJsPlayers.forEach(function(player) {\n                    // Check if player has vjs-playing class (indicates it's currently playing)\n                    var isPlaying = player.classList.contains('vjs-playing');\n                    if (isPlaying) {\n                        media.push({\n                            paused: false,\n                            element: player,\n                            type: 'videojs'\n                        });\n                    }\n                });\n            }\n\n            // Track regular HTML5 media elements\n            var internal = document.querySelectorAll('audio,video');\n            if (internal.length) {\n                internal.forEach(function(element) {\n                    // Skip Video.js elements as they're handled above\n                    if (!element.closest('.video-js')) {\n                        media.push(element);\n                    }\n                });\n            }\n\n            // Track iframe media elements (for cross-origin content)\n            var frames = document.querySelectorAll('iframe');\n            if (frames.length) {\n                frames.forEach(function(frame) {\n                    // Skip iframe if it's part of a Video.js player (already tracked above)\n                    if (frame.closest('.video-js')) {\n                        return;\n                    }\n\n                    try {\n                        // Try to access same-origin iframe content\n                        var elements = frame.contentWindow.document.querySelectorAll('audio,video');\n                        if (elements.length) {\n                            elements.forEach(function(element) {\n                                media.push(element);\n                            });\n                        }\n                    } catch (e) {\n                        // Cross-origin iframe - use alternative tracking methods\n                        log.debug('IntelliData: Cross-origin iframe detected, using alternative tracking', frame.src);\n\n                        // Check if iframe contains known media services\n                        var iframeInfo = analyzeIframeSource(frame);\n                        if (iframeInfo.hasMedia) {\n                            // For known media services, we can assume potential media activity\n                            // when iframe is visible and user is active\n                            var isVisible = isElementVisible(frame);\n                            if (isVisible) {\n                                // Add a virtual media element for tracking purposes\n                                media.push({\n                                    paused: false, // Assume playing if visible\n                                    src: frame.src,\n                                    type: iframeInfo.type\n                                });\n                            }\n                        }\n                    }\n                });\n            }\n\n            // Check if any media is playing\n            if (media.length) {\n                media.forEach(function(element) {\n                    if (!element.paused) {\n                        status = true;\n                    }\n                });\n            }\n\n            return status;\n        };\n\n        // Helper function to analyze iframe source for known media services\n        var analyzeIframeSource = function(iframe) {\n            var src = iframe.src || '';\n            if (src.includes('youtube.com') || src.includes('youtu.be')) {\n                return { type: 'youtube', hasMedia: true };\n            }\n\n            if (src.includes('vimeo.com')) {\n                return { type: 'vimeo', hasMedia: true };\n            }\n\n            return { type: 'unknown', hasMedia: false };\n        };\n\n        // Helper function to check if element is visible\n        var isElementVisible = function(element) {\n            var rect = element.getBoundingClientRect();\n            var windowHeight = window.innerHeight || document.documentElement.clientHeight;\n            var windowWidth = window.innerWidth || document.documentElement.clientWidth;\n\n            return (\n                rect.top < windowHeight &&\n                rect.bottom > 0 &&\n                rect.left < windowWidth &&\n                rect.right > 0\n            );\n        };\n\n        return {\n            init: function(params) {\n                registerParams(params);\n                registerEventListeners();\n                initTracking();\n            }\n        };\n    });\n"],"names":["define","$","log","TrackingRepository","CookiesHelper","PARAMS","AJAXFREQUENCY","INACTIVITY","PERIOD","INTERVAL","PAGE","PARAM","MEDIATRACK","TRACKING","COUNTER","AJAXCOUNTER","WARNINGTIME","LOGOUTTIME","clearCounter","resetParams","setCookie","track","mediaTracking","document","hidden","sendRequest","media","status","videoJsPlayers","querySelectorAll","length","forEach","player","classList","contains","push","paused","element","type","internal","closest","frames","frame","elements","contentWindow","e","debug","src","iframeInfo","analyzeIframeSource","hasMedia","isElementVisible","iframe","includes","rect","getBoundingClientRect","windowHeight","window","innerHeight","documentElement","clientHeight","windowWidth","innerWidth","clientWidth","top","bottom","left","right","init","params","inactivity","ajaxfrequency","period","page","param","mediatrack","registerParams","on","setInterval"],"mappings":"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"}