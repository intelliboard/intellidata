{"version":3,"file":"tracking.min.js","sources":["../src/tracking.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This plugin provides access to Moodle data in form of analytics and reports in real time.\n *\n * @copyright  2020 IntelliBoard, Inc\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @see    https://intelliboard.net/\n */\ndefine([\n    'jquery',\n    'core/log',\n    'local_intellidata/tracking_repository',\n    'local_intellidata/cookies_helper'\n],\nfunction(\n    $,\n    log,\n    TrackingRepository,\n    CookiesHelper\n) {\n\n    var PARAMS = {\n        AJAXFREQUENCY: 30,\n        INACTIVITY: 60,\n        PERIOD: 1000,\n        INTERVAL: null,\n        PAGE: '',\n        PARAM: '',\n        MEDIATRACK: 0,\n    };\n\n    var TRACKING = {\n        COUNTER: 0,\n        AJAXCOUNTER: 0,\n        WARNINGTIME: 0,\n        LOGOUTTIME: 0\n    };\n\n    var registerParams = function(params) {\n        PARAMS.INACTIVITY = params.inactivity || PARAMS.INACTIVITY;\n        PARAMS.AJAXFREQUENCY = params.ajaxfrequency || PARAMS.AJAXFREQUENCY;\n        PARAMS.PERIOD = params.period || PARAMS.PERIOD;\n        PARAMS.PAGE = params.page || PARAMS.PAGE;\n        PARAMS.PARAM = params.param || PARAMS.PARAM;\n        PARAMS.MEDIATRACK = params.mediatrack || PARAMS.MEDIATRACK;\n        log.debug('IntelliData: Set Params', [PARAMS, TRACKING]);\n    };\n\n    var registerEventListeners = function() {\n        $(document).on(\"mousemove\", clearCounter);\n        $(document).on(\"keypress\", clearCounter);\n        $(document).on(\"scroll\", clearCounter);\n        $(window).on(\"unload\", resetParams);\n    };\n\n    var clearCounter = function() {\n        TRACKING.COUNTER = 0;\n        TRACKING.WARNINGTIME = 0;\n        TRACKING.LOGOUTTIME = 0;\n    };\n\n    var resetParams = function() {\n        CookiesHelper.setCookie('intellidatapage', PARAMS.PAGE);\n        CookiesHelper.setCookie('intellidataparam', PARAMS.PARAM);\n        CookiesHelper.setCookie('intellidatatime', PARAMS.AJAXFREQUENCY);\n    };\n\n    var initTracking = function() {\n        setInterval(track, PARAMS.PERIOD);\n        log.debug('IntelliData: Start Tracking', [PARAMS, TRACKING]);\n    };\n\n    var track = function() {\n        if (PARAMS.MEDIATRACK) {\n            var status = mediaTracking();\n            if (status && !document.hidden) {\n                clearCounter();\n            }\n        }\n        if (TRACKING.COUNTER <= PARAMS.INACTIVITY) {\n            TRACKING.COUNTER++;\n            TRACKING.AJAXCOUNTER++;\n\n            if (TRACKING.AJAXCOUNTER == PARAMS.AJAXFREQUENCY && PARAMS.AJAXFREQUENCY) {\n                TrackingRepository.sendRequest(PARAMS.PAGE, PARAMS.PARAM);\n                TRACKING.AJAXCOUNTER = 0;\n            }\n        }\n    };\n\n    var mediaTracking = function(){\n        var media = [];\n        var status = false;\n        var internal = document.querySelectorAll('audio,video');\n        var frames = document.querySelectorAll('iframe');\n        if (frames.length) {\n            frames.forEach(function(frame) {\n                var elements = frame.contentWindow.document.querySelectorAll('audio,video');\n                if (elements.length) {\n                    elements.forEach(function(element) {\n                        media.push(element);\n                    });\n                }\n            });\n        }\n        if (internal.length) {\n            internal.forEach(function(element) {\n                media.push(element);\n            });\n        }\n\n        if (media.length) {\n            media.forEach(function(element) {\n                if (!element.paused) {\n                    status = true;\n                }\n            });\n        }\n\n        return status;\n    };\n\n    return {\n        init: function(params) {\n            registerParams(params);\n            registerEventListeners();\n            initTracking();\n        }\n    };\n});\n"],"names":["define","$","log","TrackingRepository","CookiesHelper","PARAMS","AJAXFREQUENCY","INACTIVITY","PERIOD","INTERVAL","PAGE","PARAM","MEDIATRACK","TRACKING","COUNTER","AJAXCOUNTER","WARNINGTIME","LOGOUTTIME","clearCounter","resetParams","setCookie","track","mediaTracking","document","hidden","sendRequest","media","status","internal","querySelectorAll","frames","length","forEach","frame","elements","contentWindow","element","push","paused","init","params","inactivity","ajaxfrequency","period","page","param","mediatrack","debug","registerParams","on","window","setInterval"],"mappings":";;;;;;;AAsBAA,oCAAO,CACH,SACA,WACA,wCACA,qCAEJ,SACIC,EACAC,IACAC,mBACAC,mBAGIC,OAAS,CACTC,cAAe,GACfC,WAAY,GACZC,OAAQ,IACRC,SAAU,KACVC,KAAM,GACNC,MAAO,GACPC,WAAY,GAGZC,SAAW,CACXC,QAAS,EACTC,YAAa,EACbC,YAAa,EACbC,WAAY,GAoBZC,aAAe,WACfL,SAASC,QAAU,EACnBD,SAASG,YAAc,EACvBH,SAASI,WAAa,GAGtBE,YAAc,WACdf,cAAcgB,UAAU,kBAAmBf,OAAOK,MAClDN,cAAcgB,UAAU,mBAAoBf,OAAOM,OACnDP,cAAcgB,UAAU,kBAAmBf,OAAOC,gBAQlDe,MAAQ,WACJhB,OAAOO,aACMU,kBACEC,SAASC,QACpBN,gBAGJL,SAASC,SAAWT,OAAOE,aAC3BM,SAASC,UACTD,SAASE,cAELF,SAASE,aAAeV,OAAOC,eAAiBD,OAAOC,gBACvDH,mBAAmBsB,YAAYpB,OAAOK,KAAML,OAAOM,OACnDE,SAASE,YAAc,KAK/BO,cAAgB,eACZI,MAAQ,GACRC,QAAS,EACTC,SAAWL,SAASM,iBAAiB,eACrCC,OAASP,SAASM,iBAAiB,iBACnCC,OAAOC,QACPD,OAAOE,SAAQ,SAASC,WAChBC,SAAWD,MAAME,cAAcZ,SAASM,iBAAiB,eACzDK,SAASH,QACTG,SAASF,SAAQ,SAASI,SACtBV,MAAMW,KAAKD,eAKvBR,SAASG,QACTH,SAASI,SAAQ,SAASI,SACtBV,MAAMW,KAAKD,YAIfV,MAAMK,QACNL,MAAMM,SAAQ,SAASI,SACdA,QAAQE,SACTX,QAAS,MAKdA,cAGJ,CACHY,KAAM,SAASC,SArFE,SAASA,QAC1BnC,OAAOE,WAAaiC,OAAOC,YAAcpC,OAAOE,WAChDF,OAAOC,cAAgBkC,OAAOE,eAAiBrC,OAAOC,cACtDD,OAAOG,OAASgC,OAAOG,QAAUtC,OAAOG,OACxCH,OAAOK,KAAO8B,OAAOI,MAAQvC,OAAOK,KACpCL,OAAOM,MAAQ6B,OAAOK,OAASxC,OAAOM,MACtCN,OAAOO,WAAa4B,OAAOM,YAAczC,OAAOO,WAChDV,IAAI6C,MAAM,0BAA2B,CAAC1C,OAAQQ,WA+E1CmC,CAAeR,QA3EnBvC,EAAEsB,UAAU0B,GAAG,YAAa/B,cAC5BjB,EAAEsB,UAAU0B,GAAG,WAAY/B,cAC3BjB,EAAEsB,UAAU0B,GAAG,SAAU/B,cACzBjB,EAAEiD,QAAQD,GAAG,SAAU9B,aAgBvBgC,YAAY9B,MAAOhB,OAAOG,QAC1BN,IAAI6C,MAAM,8BAA+B,CAAC1C,OAAQQ"}